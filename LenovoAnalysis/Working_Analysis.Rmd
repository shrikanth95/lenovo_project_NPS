---
title: "Working Analysis"
author: "ISE 560"
date: "October 21, 2019"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls())

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(out.width = "50%")
knitr::opts_chunk$set(fig.align = "center")

library(tidyverse)

source("../src_lenovo_project.R")
```


```{r}
# Read in all sentiment data
sentiment <- read.csv("../RawData/CID_Web_Sentiment.csv")

# Read in all NPS data
survey <- read.csv("../RawData/Lenovo_Survey_Data_pNPS_Rev2.csv")

# Convert Product.NPS to a numeric values


# TO DO: nps$Segment needs some cleaning
# Need to handle "blanks", "-" and convert "Consumer" to "Lenovo-Consumer" for Segmentt
# Need to handle "-" for Product.NPS
```

# SMB Products
```{r}
# Filter SMB data
sentiment.smb <- sentiment %>%
  filter(Business.Group == "LENOVO - SMB") 

# Calculate PSI by month for all SMB products
smb.psi <- sentiment.smb %>%
  group_by(year = floor_date(as.Date(Comment.Date, format = "%m/%d/%y"), unit = "year"),
           month = floor_date(as.Date(Comment.Date, format = "%m/%d/%y"), unit = "month")) %>%
  summarise(pos = sum(Sentiment == "POSITIVE"),
            neg = sum(Sentiment == "NEGATIVE")) %>%
  mutate(psi = 100 * (pos - neg)/(pos +  neg))

survey.smb <- survey %>%
  filter(Segment == "Lenovo - SMB") %>%
  mutate(NPS = as.numeric(as.character(Product.NPS))) %>%
  drop_na(NPS)

# Calculate NPS by month for all SMB producs
smb.nps <- survey.smb %>%
  group_by(year = floor_date(as.Date(Date.Survey, format = "%m/%d/%Y"), unit = "year"),
           month = floor_date(as.Date(Date.Survey, format = "%m/%d/%Y"), unit = "month")) %>%
  summarise(promoter = sum(NPS >= 9),
            detractor = sum(NPS <= 6),
            total = n()) %>%
  mutate(nps = 100 * (promoter - detractor) / total)

ggplot() +
  geom_line(data = smb.psi, mapping = aes(x=month, y=psi, color="PSI")) +
  geom_line(data = smb.nps, mapping = aes(x=month, y=nps, color="NPS")) +
  labs(title="NPS & PSI for all SMB Products")

```

## Product List
```{r}
# Get set of SMB products
smb.prods.df1 <- sort(toupper(unique(as.character(sentiment.smb$Product))))
smb.prods.df2 <- sort(toupper(unique(as.character(survey.smb$Product))))
smb.prods <- data.frame(name = I(unique(c(smb.prods.df1, smb.prods.df2)))) %>%
  mutate(have_sentiment = name %in% smb.prods.df1,
         have_survey = name %in% smb.prods.df2)

smb.prods
```

# Commercial Products
```{r}
# Filter Commercial data
sentiment.comm <- sentiment %>%
  filter(Business.Group == "LENOVO - COMMERCIAL") 

# Calculate PSI by month for all Commercial products
comm.psi <- sentiment.comm %>%
  group_by(year = floor_date(as.Date(Comment.Date, format = "%m/%d/%y"), unit = "year"),
           month = floor_date(as.Date(Comment.Date, format = "%m/%d/%y"), unit = "month")) %>%
  summarise(pos = sum(Sentiment == "POSITIVE"),
            neg = sum(Sentiment == "NEGATIVE")) %>%
  mutate(psi = 100 * (pos - neg)/(pos +  neg))

survey.comm <- survey %>%
  filter(Segment == "Lenovo - Commercial") %>%
  mutate(NPS = as.numeric(as.character(Product.NPS))) %>%
  drop_na(NPS)

# Calculate NPS by month for all Commercial producs
comm.nps <- survey.comm %>%
  group_by(year = floor_date(as.Date(Date.Survey, format = "%m/%d/%Y"), unit = "year"),
           month = floor_date(as.Date(Date.Survey, format = "%m/%d/%Y"), unit = "month")) %>%
  summarise(promoter = sum(NPS >= 9),
            detractor = sum(NPS <= 6),
            total = n()) %>%
  mutate(nps = 100 * (promoter - detractor) / total)

ggplot() +
  geom_line(data = comm.psi, mapping = aes(x=month, y=psi, color="PSI")) +
  geom_line(data = comm.nps, mapping = aes(x=month, y=nps, color="NPS")) +
  labs(title="NPS & PSI for all Commercial Products")
```



## Product List
```{r}
# Get set of Commercial products
comm.prods.df1 <- sort(toupper(unique(as.character(sentiment.comm$Product))))
comm.prods.df2 <- sort(toupper(unique(as.character(survey.comm$Product))))
comm.prods <- data.frame(name = I(unique(c(comm.prods.df1, comm.prods.df2)))) %>%
  mutate(have_sentiment = name %in% comm.prods.df1,
         have_survey = name %in% comm.prods.df2)

comm.prods
```
